<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="{{STYLE_URI}}">
</head>

<body>
    <div id="particles-js"></div>
    <div id="music-player">
        <div id="console"></div>
        <div id="error">
            <h2 class="text-light" style="margin: 0px">Hmmmm</h2>
            <h4 class="text-dark" id="message" style="opacity: 0.5"></h4>
        </div>
        <div id="lyrics" style="display: none;">
            <h4 id="lyrics-provider" style="opacity: 0.5"></h4>
            <div id="lyrics-content">
            </div>
        </div>
    </div>
    <script type="text/javascript">
        const emptyVerse = '♪ ♫ ♪';
        let globalLyrics = [];
        let currentIndex = -1;
        let lyricsTimer = null;
        let globalProgress = 0;

        const updateConsole = msg => {
            const el = document.getElementById('console')
            el.innerHTML = `${msg}<br>${el.innerHTML}`
        }
        
        function extractAndConvertToMilliseconds(text) {
            const timePattern = /\[(\d{2}):(\d{2})\.(\d{2})\]/;
            const match = text.match(timePattern);

            if (!match) throw 'Invalid format'

            const [, minutes, seconds, centiseconds] = match;
            return (parseInt(minutes, 10) * 60 * 1000) +
                (parseInt(seconds, 10) * 1000) +
                (parseInt(centiseconds, 10) * 10);
        }

        function prepareLyrics(lyrics) {
            if (lyrics.syncedLyric) {
                const lines = lyrics.syncedLyric;
                globalLyrics = lines.map(line => {
                    const time = extractAndConvertToMilliseconds(line);
                    const lyric = line.split("]")[1].trim();
                    return { time: time, text: lyric || emptyVerse };
                });
                if (globalLyrics.length && globalLyrics[0].time !== 0)
                    globalLyrics.unshift({ time: 0, text: emptyVerse });
            } else if (lyrics.plainLyric) {
                const lines = lyrics.plainLyric;
                if (lines.length && lyrics.instrumental) {
                    globalLyrics = [{ time: 0, text: emptyVerse }];
                } else {
                    globalLyrics = lines.map(line => {
                        const lyric = line.trim();
                        return { time: null, text: lyric || emptyVerse };
                    });
                }
            }

            const provider = document.getElementById('lyrics-provider')
            if (provider)
                provider.innerHTML = `Lyrics provider: ${lyrics.provider}` + (lyrics.syncedLyric ? '' : lyrics.instrumental ? ' (Instrumental)' : ' (Not synced)');

            const screen = document.getElementById("lyrics-content")
            screen.innerHTML = ''

            globalLyrics.forEach(({ time, text }) => {
                const element = document.createElement('h2');
                element.id = String(time)
                element.classList.add('title', 'text-dark')
                if (text === emptyVerse) element.classList.add('centered')
                const match = text.match(/(^\([^)]+\)|\([^)]+\)$)/);
                element.textContent = (match ? text.replace(match[1], '').trim() : text)
                screen.appendChild(element)

                if (!match) return;
                const subtitle = document.createElement('h3');
                subtitle.id = `${time}-subtitle`
                subtitle.classList.add('sub-title', 'text-dark')
                subtitle.textContent = match[1]
                screen.appendChild(subtitle)
            });
        }

        function setActiveLyric() {
            let index = -1
            globalLyrics.forEach(({ time, text }, idx) => {
                if (time === null) return;
                const item = document.getElementById(`${time}`)
                if (globalProgress < time) {
                    item.classList.remove('text-light')
                    item.classList.add('text-dark')
                    const sub = document.getElementById(`${time}-subtitle`)
                    if (!sub) return;

                    sub.classList.remove('text-light')
                    sub.classList.add('text-dark')
                    return;
                }

                item.classList.remove('text-dark')
                item.classList.add('text-light')
                index = idx
                const sub = document.getElementById(`${time}-subtitle`)
                if (!sub) return;

                sub.classList.remove('text-dark')
                sub.classList.add('text-light')
            })
            
            // updateConsole(`Calculed index: ${index}`)
            // updateConsole(`Current index: ${currentIndex}`)
            // if (index < 0) document.getElementById('lyrics-content').scrollTo({ top: 0, behavior: 'smooth' });
            if (index == currentIndex) return;

            const lyric = globalLyrics[index];
            if (!lyric || lyric.time === null) return;

            const prev = document.querySelector('.actual-lyric');
            const node = document.getElementById(lyric.time);
            
            // document.getElementById('lyrics-content').scrollTo({
            //     top: node.offsetTop + (node.offsetHeight / 2) - (document.getElementById('lyrics-content').clientHeight / 2),
            //     behavior: 'smooth'
            // });
            
            
            // updateConsole(`Setting currentIndex to: ${index}`)
            currentIndex = index;

            if (prev && prev.id === node.id) return;
            
            if (prev) {
                prev.classList.remove('actual-lyric')
                const prev_sub = document.getElementById(`${prev.id}-subtitle`)
                if (prev_sub) prev_sub.classList.remove('actual-lyric')
            }

            node.classList.add('actual-lyric');
            const node_sub = document.getElementById(`${node.id}-subtitle`)
            if (node_sub) node_sub.classList.add('actual-lyric')
            wrapWaveSpansFor(node);

            document.getElementById('lyrics-content').scrollTo({
                top: document.getElementById(lyric.time).offsetTop + (document.getElementById(lyric.time).offsetHeight / 2) - (document.getElementById('music-player').clientHeight / 2),
                behavior: 'smooth'
            });
        }

        function wrapWaveSpansFor(node) {
            if (!node) return;
            if (node.dataset.waved) return;

            let offset = 0
            const genList = (word, element) => {
                for (let i = 0 + offset; i < word.length + offset; i++) {
                    const ch = word[i - offset];
                    const span = document.createElement('span');
                    span.textContent = ch;
                    span.classList.add('char_span')
                    if (['♪', '♫'].includes(ch)) {
                        span.style.animationIterationCount = 'infinite';
                        span.style.animationDuration = '2s';
                    }
                    span.style.setProperty('--i', i);
                    element.appendChild(span);
                }
                offset += word.length
            }

            const text = node.textContent ?? '';
            node.innerHTML = '';
            text.split(' ').forEach(word => {
                const trimmed_word = word.trim();
                if (!trimmed_word) return;
                const word_span = document.createElement('span');
                word_span.classList.add('word_span');
                genList(trimmed_word, word_span);
                node.appendChild(word_span)
            })
            const subtitle = document.getElementById(`${node.id}-subtitle`)
            if (subtitle) {
                // subtitle.classList.add('actual-lyric')
                offset = 0
                const sub_text = subtitle.textContent ?? '';
                subtitle.innerHTML = '';
                sub_text.split(' ').forEach(word => {
                    const trimmed_word = word.trim();
                    if (!trimmed_word) return;
                    const word_span = document.createElement('span');
                    word_span.classList.add('word_span');
                    genList(trimmed_word, word_span);
                    subtitle.appendChild(word_span)
                })
            }
            node.dataset.waved = '1';
        }


        window.addEventListener("message", (event) => {
            if (event.data.command == 'error') {
                document.getElementById('lyrics').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('message').innerText = event.data.message;
                return;
            }
            if (event.data.command == 'updateProgress') {
                const milliseconds = event.data.content;
                globalProgress = milliseconds;
                if (currentIndex >= 0 && globalProgress < globalLyrics[currentIndex].time || 0) {
                    // updateConsole(`Resetting currentIndex to: -1`)
                    currentIndex = -1
                }
                setActiveLyric();
                return;
            }
            if (event.data.command == 'updateLyrics') {
                document.getElementById('lyrics').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                const lyrics = event.data.content;
    
                prepareLyrics(lyrics);
                // updateConsole(`Resetting currentIndex to: -1 because of new lyrics`)
                currentIndex = -1;
                return;
            }
            document.getElementById('lyrics').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('message').innerText = `Unknown data: ${event.data}`;
        }, false);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script src="{{PARTICLES_URI}}"></script>
</body>

</html>